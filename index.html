let voicesReady = false;

function preloadVoices() {
  if ('speechSynthesis' in window) {
    window.speechSynthesis.onvoiceschanged = () => {
      voicesReady = true;
    };
    // Force voice list to load
    window.speechSynthesis.getVoices();
  }
}

function speakPhoneme(letter){
  const text = phonemeMap[letter.toUpperCase()] || letter;
  if('speechSynthesis' in window){
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'en-US';
    utter.rate = 0.9;
    utter.pitch = 1.0;

    const voices = window.speechSynthesis.getVoices();
    if(voices && voices.length){
      const preferred = voices.find(v => /female|samantha|karen|amy|zira/i.test(v.name))
                        || voices.find(v => v.lang.startsWith('en'))
                        || voices[0];
      if(preferred) utter.voice = preferred;
    }

    window.speechSynthesis.speak(utter);
  } else {
    console.log('Speech not supported');
  }
}

// Call once after first user interaction
document.body.addEventListener('click', preloadVoices, { once: true });
